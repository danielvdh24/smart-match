{% load i18n static %}<!DOCTYPE html>
{% get_current_language as LANGUAGE_CODE %}{% get_current_language_bidi as LANGUAGE_BIDI %}
<html lang="{{ LANGUAGE_CODE|default:"en-us" }}" dir="{{ LANGUAGE_BIDI|yesno:'rtl,ltr,auto' }}">
<head>
<title>{% block title %}{% endblock %}</title>
<link rel="stylesheet" href="{% block stylesheet %}{% static "admin/css/base.css" %}{% endblock %}">
{% block dark-mode-vars %}
  <link rel="stylesheet" href="{% static "admin/css/dark_mode.css" %}">
  <script src="{% static "admin/js/theme.js" %}" defer></script>
{% endblock %}
{% if not is_popup and is_nav_sidebar_enabled %}
  <link rel="stylesheet" href="{% static "admin/css/nav_sidebar.css" %}">
  <script src="{% static 'admin/js/nav_sidebar.js' %}" defer></script>
{% endif %}
{% block extrastyle %}{% endblock %}
{% if LANGUAGE_BIDI %}<link rel="stylesheet" href="{% block stylesheet_rtl %}{% static "admin/css/rtl.css" %}{% endblock %}">{% endif %}
{% block extrahead %}{% endblock %}
{% block responsive %}
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="{% static "admin/css/responsive.css" %}">
    {% if LANGUAGE_BIDI %}<link rel="stylesheet" href="{% static "admin/css/responsive_rtl.css" %}">{% endif %}
{% endblock %}
{% block blockbots %}<meta name="robots" content="NONE,NOARCHIVE">{% endblock %}
</head>

<body class="{% if is_popup %}popup {% endif %}{% block bodyclass %}{% endblock %}"
  data-admin-utc-offset="{% now "Z" %}">
<a href="#content-start" class="skip-to-content-link">{% translate 'Skip to main content' %}</a>
<!-- Container -->
<div id="container">

    {% if not is_popup %}
    <!-- Header -->
    {% block header %}
    <div id="header">
        <div id="branding">
        {% block branding %}{% endblock %}
        </div>
        {% block usertools %}
        {% if has_permission %}
        <div id="user-tools">
            {% block welcome-msg %}
                {% translate 'Welcome,' %}
                <strong>{% firstof user.get_short_name user.get_username %}</strong>.
            {% endblock %}
            {% block userlinks %}
                {% if site_url %}
                    <a href="{{ site_url }}">{% translate 'View site' %}</a> /
                {% endif %}
                {% if user.is_active and user.is_staff %}
                    {% url 'django-admindocs-docroot' as docsroot %}
                    {% if docsroot %}
                        <a href="{{ docsroot }}">{% translate 'Documentation' %}</a> /
                    {% endif %}
                {% endif %}
                {% if user.has_usable_password %}
                <a href="{% url 'admin:password_change' %}">{% translate 'Change password' %}</a> /
                {% endif %}
                <form id="logout-form" method="post" action="{% url 'admin:logout' %}">
                    {% csrf_token %}
                    <button type="submit">{% translate 'Log out' %}</button>
                </form>
                {% include "admin/color_theme_toggle.html" %}
            {% endblock %}
        </div>
        {% endif %}
        {% endblock %}
        {% block nav-global %}{% endblock %}
    </div>
    {% endblock %}
    <!-- END Header -->
    {% block nav-breadcrumbs %}
      <nav aria-label="{% translate 'Breadcrumbs' %}">
        {% block breadcrumbs %}
          <div class="breadcrumbs">
            <a href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
            {% if title %} &rsaquo; {{ title }}{% endif %}
          </div>
        {% endblock %}
      </nav>
    {% endblock %}
    {% endif %}

    <div class="main" id="main">
      {% if not is_popup and is_nav_sidebar_enabled %}
        {% block nav-sidebar %}
          {% include "admin/nav_sidebar.html" %}
        {% endblock %}
      {% endif %}
      <div id="content-start" class="content" tabindex="-1">
        {% block messages %}
          {% if messages %}
            <ul class="messagelist">{% for message in messages %}
              <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message|capfirst }}</li>
            {% endfor %}</ul>
          {% endif %}
        {% endblock messages %}
        <!-- Content -->
        <div id="content" class="{% block coltype %}colM{% endblock %}">
          {% block pretitle %}{% endblock %}
          {% block title-modelchoices-container %}
          <div id="title-modelchoices-container">
              {% block content_title %}{% if title %}<h1>{{ title }}</h1>{% endif %}{% endblock %}
              {% if title != "Logged out" %}
              <div id="modelchoices-div">
                <button id="train-new-model-btn" type="button">Train</button>
                <button id="evaluate-model-btn" type="button">Evaluate</button>
                <div class="dropdown">
                  <button class="dropbtn">--- Select Version ---</button>
                  <div class="dropdown-content" id="dropdown-content"></div>
                </div>

                <form id="uploadCsvForm" enctype="multipart/form-data" method="post">
                  {% csrf_token %}
                  <input type="file" name="csv_file" id="csvFileInput">
                  <button type="submit">Upload CSV</button>
                </form>
                <div id="uploadCsvMessage"></div>
                <script>
                  document.getElementById("uploadCsvForm").addEventListener("submit", async function (e) {
                  e.preventDefault();

                  const formData = new FormData();
                  const fileInput = document.getElementById("csvFileInput");

                  if (fileInput.files.length === 0) {
                      document.getElementById("uploadCsvMessage").innerText = "Please select a file to upload.";
                      return;
                  }

                  formData.append("csv_file", fileInput.files[0]);

                  //CSRF token
                  function getCsrfToken() {
                      const csrfCookie = document.cookie.split("; ").find(row => row.startsWith("csrftoken="));
                      return csrfCookie ? csrfCookie.split("=")[1] : null;
                  }

                  const csrfToken = getCsrfToken();

                  try {
                      const response = await fetch("{% url 'upload_csv' %}", {
                          method: "POST",
                          headers: {
                              "X-CSRFToken": csrfToken
                          },
                          body: formData,
                      });

                      if (!response.ok) {
                          throw new Error("Network response was not ok");
                      }

                      const result = await response.json();
                      const messageElement = document.getElementById("uploadCsvMessage");

                      messageElement.innerText = result.message;
                  } catch (error) {
                      document.getElementById("uploadCsvMessage").innerText = "Error uploading the file.";
                      console.error(error);
                  }
              });
              </script>            

              </div>    
              {% endif %}
          </div>
          {% endblock %}
          {% block content_subtitle %}{% if subtitle %}<h2>{{ subtitle }}</h2>{% endif %}{% endblock %}
          {% block content %}
            {% block object-tools %}{% endblock %}
            {{ content }}
          {% endblock %}
          {% block sidebar %}{% endblock %}
          <br class="clear">
        </div>
        <!-- END Content -->
        {% block footer %}<div id="footer"></div>{% endblock %}
      </div>
    </div>
    <div id="new-version-model-modal-container" class="hidden">
      <div id="new-version-model-modal">
        <div id="new-version-model-content">
          <div id="new-version-name-container">
            <h2>Enter Name of New Version:</h2>
          </div>
          <div> Latest trained model version: <span id="latest-trained-vers"></span></div>
          <input type="text" id="text-input-major" placeholder="Major (0) :" />
          <input type="text" id="text-input-minor" placeholder="Minor (0) :" />
          <input type="text" id="text-input-patch" placeholder="Patch (0) :" />
          <div id="error-vers-prompt" class="hidden">"Error: Fill Each Input With Numbers Only"</div>
          <div>
            <button type="button" id="cancel-new-model-btn">Back</button>
            <button id="train-confirm-new-model-btn" type="button">Train</button>
<pre id="training-res-output" class="hidden">Training ...</pre>
          </div>
        </div>
      </div>
    </div>
</div>
<!-- END Container -->

<!-- SVGs -->
<svg xmlns="http://www.w3.org/2000/svg" class="base-svgs">
  <symbol viewBox="0 0 24 24" width="1rem" height="1rem" id="icon-auto"><path d="M0 0h24v24H0z" fill="currentColor"/><path d="M12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10-4.477 10-10 10zm0-2V4a8 8 0 1 0 0 16z"/></symbol>
  <symbol viewBox="0 0 24 24" width="1rem" height="1rem" id="icon-moon"><path d="M0 0h24v24H0z" fill="currentColor"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol>
  <symbol viewBox="0 0 24 24" width="1rem" height="1rem" id="icon-sun"><path d="M0 0h24v24H0z" fill="currentColor"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol>
</svg>
<!-- END SVGs -->
 <script>

  // global state / event / transition variables
  let timeoutInputError = 0
  let timeoutSoonDone = 0
  let timeoutFinalizing = 0


    // Frequently targeted elements accross functions
  const majorInput = document.getElementById("text-input-major");
  const minorInput = document.getElementById("text-input-minor");
  const patchInput = document.getElementById("text-input-patch");

  const latestTrainedVers = document.getElementById("latest-trained-vers")

  const trainConfirmBtn = document.getElementById("train-confirm-new-model-btn")

  const backTrainBtn = document.getElementById("cancel-new-model-btn")

  const errorDiv = document.getElementById("error-vers-prompt");

  const trainingResOutput = document.getElementById("training-res-output")

  const dropdownContent = document.getElementById('dropdown-content');



    // Get names of all model versions 
    fetch("/fetch-all-models/", { // URL of the Django view
    method: "GET",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken"), // CSRF protection
    }
  }).then(response => response.json())
    .then(data => {
      if (data.success) {
        
        dataOutputObj = data.output
        console.log(dataOutputObj)
        
        const li = document.createElement('li');
        li.textContent = `(Newest) ${dataOutputObj.highest_version_file}`;
        li.id = "dropdown-latest-model"
        dropdownContent.appendChild(li);

        
        
        dataOutputObj.model_files_restof.forEach(item =>  {
          const li = document.createElement('li');
          li.textContent = item
          dropdownContent.appendChild(li);
        });

      } else {
        dropdownContent.textContent = `Error: ${data.error}`;
        console.log("ijk")
      }
    })
  .catch(error => console.error("Error:", error));


  //Get info about latest model from server. Server vs client side job for this could be argued in this case server side job for this is chosen due to convenience and potential user side benefits (in terms of performance)
  fetch("/fetch-latest-model/", { // URL of the Django view
    method: "GET",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken"), // CSRF protection
    }
  }).then(response => response.json())
    .then(data => {
      if (data.success) {
        latestTrainedVers.textContent = data.output;
      } else {
        latestTrainedVers.textContent = `Error: ${data.error}`;
      }
    })
  .catch(error => console.error("Error:", error));


document.getElementById("train-new-model-btn").addEventListener("click", function() {

  const modal = document.getElementById("new-version-model-modal-container");
  modal.classList.remove("hidden");

});


document.getElementById("train-new-model-btn").addEventListener("click", function() {

})


// Event listener for Back button to hide the modal
document.getElementById("cancel-new-model-btn").addEventListener("click", function() {
  const modal = document.getElementById("new-version-model-modal-container");
  modal.classList.add("hidden");


  // Reset certain states for a default-view look upon potential user re-entry to the train-model view again. 
  trainingResOutput.classList.add("hidden");
  errorDiv.classList.add("hidden");
});




document.getElementById("dropdown-content").addEventListener("click", (event) => {
    // Check if the clicked element is a link
    if (event.target.tagName === "A") {
      console.log("Clicked an item");
    }
  });




trainConfirmBtn.addEventListener("click", function() {

  const result = validate()

  if (result.isValid) {
    

    this.classList.add("hidden");
    backTrainBtn.classList.add("hidden")
    clearTimeout(timeoutInputError)
    errorDiv.classList.add("hidden")
    
    versionPost(result.inputs)

    trainingResOutput.textContent = "Training ..."
    trainingResOutput.classList.remove("hidden")
    
    timeoutSoonDone = setTimeout(() => {
        trainingResOutput.textContent = "Soon Done ...";
    }, 11000);

    timeoutFinalizing = setTimeout(() => {
        trainingResOutput.textContent = "Finalizing ...";
    }, 19000);

  }
});






function validate(){

      // Validate inputs
      const inputs = [majorInput, minorInput, patchInput];
      let isCorrectInputDataType = true;
      let isCorrectVersionIncrement = true;
      let inputtedVersionsParts = []
      inputs.forEach(input => {
        const val = input.value
        if (!/^\d*$/.test(val) || val == "") {
          isCorrectInputDataType = false;
          return; // Stop further iteration if invalid input is found
        }

        inputtedVersionsParts.push(val)
      });


      if (isCorrectInputDataType) {

        const latestVersString = latestTrainedVers.textContent

        const versionMatch = latestVersString.match(/\d+\.\d+\.\d+/);

        const latestVersionsParts = versionMatch[0].split('.')


        // Convert elements to integers to AVOID lexicographic comparison (e.g., '10000000' < '9' == true for strings)
        for (let i = 0; i < inputtedVersionsParts.length; i++) {
          inputtedVersionsParts[i] = parseInt(inputtedVersionsParts[i], 10);
          latestVersionsParts[i] = parseInt(latestVersionsParts[i], 10);
        }


        // Check each :nth place in semvar version input to ensure correct planned version increment
        if ((inputtedVersionsParts[0] < latestVersionsParts[0])){

          isCorrectVersionIncrement = false
          
        } else if (inputtedVersionsParts[0] == latestVersionsParts[0]){
        
          if (inputtedVersionsParts[1] <  latestVersionsParts[1]) {

            isCorrectVersionIncrement = false

          } else if (inputtedVersionsParts[1] == latestVersionsParts[1]){

            if (inputtedVersionsParts[2] <= latestVersionsParts[2]){
                            
              isCorrectVersionIncrement = false
            }
          }
        }
      }

      // Show error message if invalid input found
      if (!isCorrectInputDataType || !isCorrectVersionIncrement) {

        errorDiv.classList.remove("hidden");
        errorDiv.textContent =  (!isCorrectInputDataType) ? "Error: Fill Each Input With Numbers Only" : "Error: Version Has To Increment"
        
        clearTimeout(timeoutInputError)
        timeoutInputError = setTimeout(() => {
          errorDiv.classList.add("hidden");
        }, 5000);

        inputs.forEach(input => {
          input.value = ""
        })

      }

      return {isValid: isCorrectInputDataType & isCorrectVersionIncrement, inputs: inputs.map((input) => input.value)};
}



function versionPost(inputs){

  fetch("/train-command/", { // URL of the Django view
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken"), // CSRF protection
    },
    body: JSON.stringify(inputs),
  })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        trainingResOutput.textContent = data.output;

        const versionMatch = data.output.match(/\d+\.\d+\.\d+/);

        const versionString = versionMatch[0]

        // Update the latest trained model hint
        latestTrainedVers.textContent = `model_v${versionString} -- latest --`

        // Add newly trained model to list of available models
        const li = document.createElement('li');
        li.textContent = `model_v${versionString}`;
        dropdownContent.appendChild(li);


      } else {
        trainingResOutput.textContent = `Error: ${data.error}`;
      }


      // Resets certain states for some prompts to "neutral"
      majorInput.value = ""
      minorInput.value = ""
      patchInput.value = ""


      clearTimeout(timeoutSoonDone)
      clearTimeout(timeoutFinalizing)


      trainConfirmBtn.classList.remove("hidden");
      backTrainBtn.classList.remove("hidden")

    })
    .catch(error => console.error("Error:", error));
    
}



// Helper function to get the CSRF token from cookies
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}


 </script>
</body>
</html>
